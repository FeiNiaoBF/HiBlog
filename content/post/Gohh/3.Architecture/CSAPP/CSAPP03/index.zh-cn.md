---
title: "三.处理器设计(CSAPP)"
date: 2023-04-09T20:13:06+08:00
draft: True
tags: [CSAPP]
categories: ["CSAPP","CS"]
author: ["Yeelight"]
showtoc: true
math: false
weight:
readingTime: true
---


## 前言

其实说实话我不是很想写这部分的，因为不同的硬件逻辑和具体实现是互不相同的，各有优劣。况且，我在学校里面使用的竟是一个没有实际用途的教学用的芯片 AX20091，老师也是对着一份年代久远的 PPT 讲，嘴上说着组成十分重要，但我们真听不懂。因此我写下这部分来，希望对我有帮助也对后面的人有帮助。

本文是基于 RISC-v 计算器的原理来设计处理器，以*计算机组成与设计硬件软件接口 (RISC-V 版)* 为指南。

## 数据通路的设计

对于一个计算机而言设计一个简单而功能强大的硬件是一件困难的事情，而RISC-V在硬件逻辑和扩展上有着一定的优势（比起x86-64要美观的许多）。数据通路（Datapath）简单来讲是一个大集合，生产线。将各个单元组块集合起来，利用时钟同步的方式使得每个组块的输入输出可以通过合理的逻辑方法解决指令的任务（如：add、sub、ld、sd等）

RISC-V的逻辑单元有两种：
- 组合逻辑单元（可以有输入输出且用时钟控制的逻辑单元）
- 状态逻辑单元（更多是利用RAM的技术来存储值）

设计数据通络首先就要了解每种指令所需要的数据通路元素（datapath elements），这是一个用于操作或者保存数据的功能单位。在RISC-V的实现当中，数据通路的元素包括指令以及数据存储器、寄存器组、ALU以及加法器。

### 程序计数器（PC）

第一个要了解的是取值了，而 **Programs counter PC** 的工作就是保存当前的指令并在一时钟后通过ALU的ADD+4/+offset来取得下一指令的地址（有个问题，我们说PC是指向下个指令的指针，但在这里我们可以看见PC有两个值也就说在时钟前PC是上条指令，时钟后是下条指令，换句话说PC里有一个可以存值的硬件，其实是有一个触发器，即PC也是一个组合逻辑单元）

![](https://s2.loli.net/2023/06/03/5iws4eduImhDRQX.png)

- 如上图，有三个元素，一个存储指令存储器，一个获取指令PC，一个加法器用于计算下一条指令的地址。在RISC-V数据通路的实现当中，指令存储器是不需要写入的，因此我们可以把它看作是一个组合逻辑器件：它的输出只取决于输入的地址，并且不需要读取的控制信号。PC是一个64位（RV32I则是32位）的寄存器，它在每个时钟周期的结束时更新。加法器则是一个控制信号被固定为是加法的ALU，永远将它的两个64位的输入相加输出64位的结果。

下面是将上图中的3个器件组合起来表现取指以及递增PC的数据通路图：

![](https://s2.loli.net/2023/06/03/2kdhViUvJWj59XT.png)

其实从这里可以看到，数据通络开始闭环起来了（我不知道说的对不对），即数据通路的开始要考虑只和主存相连。

### R 类型等操作

现在来考虑 R 类型的指令 (如: **add, sub** 等)，这些指令都可以从寄存器堆中依据寄存器号读取两个源寄存器，再进行 ALU 操作，然后将结果写入到一个依据目标寄存器号存入目标寄存器当中。这种类型称为 R 类型指令或者叫算术-逻辑指令，包括 **ADD、SUB、AND 以及 OR** 等。

> 寄存器组是包含一组寄存器的器件，可以提供一个寄存器号来进行读取或者写入。处理器中的通用寄存器都存储在寄存器组当中。

![Registers](https://s2.loli.net/2023/06/08/RT5Gj6or3cyPlZx.png)

R 类型的指令一共需要3个操作数，因此我们需要从两个源寄存器中读取两个数据字，然后将计算得到的结果数据字写入到目标寄存器当中。

> 输入寄存器号的位宽为5bit，所以通用寄存器一共有32（2<sup>5</sup>）个。需要注意的一点是，对于所有的输入信号即：3个输入寄存器号和1个写入数据字都是在时钟上升沿（当前时钟周期）的时候才有效。在下个时钟上升沿（下个时钟周期）写入寄存器，其值是上一个时钟沿计算好的值。

对于寄存器组的读取不需要选择信号，只要对应读取寄存器号有效其中也有正确的值，对应的输出端就会输出相应寄存器的数据字。但寄存器组的写入需要信号，RegWrite。只有当时钟上升沿到来并且 **RegWrite** 为真的时候才能写入寄存器组。

图 b 是 ALU 的实现，“ALUoperation” 的控制信号是选择 ALU 将要执行的操作信号，为4位位宽。ALU 输入的值是两个64位（RV32I 为32位）的操作数，输出的是一个64位（RV32I 为32位）的计算结果，以及一个1位的信号，用于判断计算结果是否为0。

### 存取指令

#RISC-V
